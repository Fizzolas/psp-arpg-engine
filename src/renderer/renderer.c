#include "renderer/renderer.h"
#include <pspkernel.h>
#include <pspdisplay.h>
#include <pspgu.h>
#include <pspgum.h>
#include <string.h>
#include <malloc.h>

#define BUF_WIDTH (512)
#define SCR_WIDTH (480)
#define SCR_HEIGHT (272)
#define PIXEL_SIZE (4) // 32-bit RGBA8888
#define FRAME_SIZE (BUF_WIDTH * SCR_HEIGHT * PIXEL_SIZE)
#define ZBUF_SIZE (BUF_WIDTH * SCR_HEIGHT * 2)

static unsigned int __attribute__((aligned(16))) list[262144];
static void* fbp0 = 0;
static void* fbp1 = 0;
static void* zbp = 0;

// 5x7 bitmap font for debug text
static const unsigned char font_data[95][7] = {
    // Simplified ASCII 32-126
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // Space
    {0x04,0x04,0x04,0x04,0x00,0x04,0x00}, // !
    {0x0A,0x0A,0x00,0x00,0x00,0x00,0x00}, // "
    {0x0A,0x1F,0x0A,0x1F,0x0A,0x00,0x00}, // #
    {0x04,0x0F,0x14,0x0E,0x05,0x1E,0x04}, // $
    {0x18,0x19,0x02,0x04,0x08,0x13,0x03}, // %
    {0x0C,0x12,0x14,0x08,0x15,0x12,0x0D}, // &
    {0x04,0x04,0x00,0x00,0x00,0x00,0x00}, // '
    {0x02,0x04,0x08,0x08,0x08,0x04,0x02}, // (
    {0x08,0x04,0x02,0x02,0x02,0x04,0x08}, // )
    {0x00,0x0A,0x04,0x0E,0x04,0x0A,0x00}, // *
    {0x00,0x04,0x04,0x1F,0x04,0x04,0x00}, // +
    {0x00,0x00,0x00,0x00,0x04,0x04,0x08}, // ,
    {0x00,0x00,0x00,0x1F,0x00,0x00,0x00}, // -
    {0x00,0x00,0x00,0x00,0x00,0x04,0x00}, // .
    {0x00,0x01,0x02,0x04,0x08,0x10,0x00}, // /
    {0x0E,0x11,0x13,0x15,0x19,0x11,0x0E}, // 0
    {0x04,0x0C,0x04,0x04,0x04,0x04,0x0E}, // 1
    {0x0E,0x11,0x01,0x02,0x04,0x08,0x1F}, // 2
    {0x1F,0x02,0x04,0x02,0x01,0x11,0x0E}, // 3
    {0x02,0x06,0x0A,0x12,0x1F,0x02,0x02}, // 4
    {0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E}, // 5
    {0x06,0x08,0x10,0x1E,0x11,0x11,0x0E}, // 6
    {0x1F,0x01,0x02,0x04,0x08,0x08,0x08}, // 7
    {0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E}, // 8
    {0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C}, // 9
    {0x00,0x04,0x00,0x00,0x00,0x04,0x00}, // :
    {0x00,0x04,0x00,0x00,0x04,0x04,0x08}, // ;
    {0x02,0x04,0x08,0x10,0x08,0x04,0x02}, // <
    {0x00,0x00,0x1F,0x00,0x1F,0x00,0x00}, // =
    {0x08,0x04,0x02,0x01,0x02,0x04,0x08}, // >
    {0x0E,0x11,0x01,0x02,0x04,0x00,0x04}, // ?
    // Continue with more characters...
    // Abbreviated for space - full font would include A-Z, a-z, symbols
    {0x0E,0x11,0x11,0x1F,0x11,0x11,0x11}, // A (65-32=33)
    {0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E}, // B
    {0x0E,0x11,0x10,0x10,0x10,0x11,0x0E}, // C
    {0x1C,0x12,0x11,0x11,0x11,0x12,0x1C}, // D
    {0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F}, // E
    {0x1F,0x10,0x10,0x1E,0x10,0x10,0x10}, // F
    {0x0E,0x11,0x10,0x17,0x11,0x11,0x0F}, // G
    {0x11,0x11,0x11,0x1F,0x11,0x11,0x11}, // H
    {0x0E,0x04,0x04,0x04,0x04,0x04,0x0E}, // I
    {0x07,0x02,0x02,0x02,0x02,0x12,0x0C}, // J
    {0x11,0x12,0x14,0x18,0x14,0x12,0x11}, // K
    {0x10,0x10,0x10,0x10,0x10,0x10,0x1F}, // L
    {0x11,0x1B,0x15,0x15,0x11,0x11,0x11}, // M
    {0x11,0x11,0x19,0x15,0x13,0x11,0x11}, // N
    {0x0E,0x11,0x11,0x11,0x11,0x11,0x0E}, // O
    {0x1E,0x11,0x11,0x1E,0x10,0x10,0x10}, // P
    {0x0E,0x11,0x11,0x11,0x15,0x12,0x0D}, // Q
    {0x1E,0x11,0x11,0x1E,0x14,0x12,0x11}, // R
    {0x0F,0x10,0x10,0x0E,0x01,0x01,0x1E}, // S
    {0x1F,0x04,0x04,0x04,0x04,0x04,0x04}, // T
    {0x11,0x11,0x11,0x11,0x11,0x11,0x0E}, // U
    {0x11,0x11,0x11,0x11,0x11,0x0A,0x04}, // V
    {0x11,0x11,0x11,0x15,0x15,0x15,0x0A}, // W
    {0x11,0x11,0x0A,0x04,0x0A,0x11,0x11}, // X
    {0x11,0x11,0x11,0x0A,0x04,0x04,0x04}, // Y
    {0x1F,0x01,0x02,0x04,0x08,0x10,0x1F}, // Z
    // Remaining characters abbreviated for space
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // [...]
};

void rendererInit(void) {
    // Allocate frame buffers
    fbp0 = (void*)0x04000000;
    fbp1 = (void*)0x04000000 + FRAME_SIZE;
    zbp = (void*)0x04000000 + FRAME_SIZE * 2;
    
    sceGuInit();
    sceGuStart(GU_DIRECT, list);
    sceGuDrawBuffer(GU_PSM_8888, fbp0, BUF_WIDTH);
    sceGuDispBuffer(SCR_WIDTH, SCR_HEIGHT, fbp1, BUF_WIDTH);
    sceGuDepthBuffer(zbp, BUF_WIDTH);
    sceGuOffset(2048 - (SCR_WIDTH / 2), 2048 - (SCR_HEIGHT / 2));
    sceGuViewport(2048, 2048, SCR_WIDTH, SCR_HEIGHT);
    sceGuDepthRange(65535, 0);
    sceGuScissor(0, 0, SCR_WIDTH, SCR_HEIGHT);
    sceGuEnable(GU_SCISSOR_TEST);
    sceGuAlphaFunc(GU_GREATER, 0, 0xff);
    sceGuEnable(GU_ALPHA_TEST);
    sceGuDepthFunc(GU_GEQUAL);
    sceGuEnable(GU_DEPTH_TEST);
    sceGuFrontFace(GU_CW);
    sceGuShadeModel(GU_SMOOTH);
    sceGuEnable(GU_CULL_FACE);
    sceGuEnable(GU_CLIP_PLANES);
    sceGuFinish();
    sceGuSync(0, 0);
    sceDisplayWaitVblankStart();
    sceGuDisplay(GU_TRUE);
}

void rendererShutdown(void) {
    sceGuTerm();
}

void rendererClearScreen(unsigned int color) {
    sceGuStart(GU_DIRECT, list);
    sceGuClearColor(color);
    sceGuClearDepth(0);
    sceGuClear(GU_COLOR_BUFFER_BIT | GU_DEPTH_BUFFER_BIT);
    sceGuFinish();
    sceGuSync(0, 0);
}

void rendererSwapBuffers(void) {
    sceGuSwapBuffers();
    sceDisplayWaitVblankStart();
}

void rendererDrawText(int x, int y, const char* text, unsigned int color) {
    // Software text rendering using bitmap font
    int cx = x;
    int cy = y;
    
    while (*text) {
        if (*text >= 32 && *text < 127) {
            int glyph_idx = *text - 32;
            if (glyph_idx >= 0 && glyph_idx < 95) {
                for (int row = 0; row < 7; row++) {
                    unsigned char bits = font_data[glyph_idx][row];
                    for (int col = 0; col < 5; col++) {
                        if (bits & (1 << (4 - col))) {
                            rendererDrawRect(cx + col, cy + row, 1, 1, color);
                        }
                    }
                }
            }
        }
        cx += 6;
        text++;
    }
}

void rendererDrawRect(int x, int y, int width, int height, unsigned int color) {
    // Draw directly to framebuffer
    unsigned int* vram = (unsigned int*)sceGuSwapBuffers();
    if (!vram) vram = (unsigned int*)fbp0;
    
    for (int py = 0; py < height; py++) {
        for (int px = 0; px < width; px++) {
            int sx = x + px;
            int sy = y + py;
            if (sx >= 0 && sx < SCR_WIDTH && sy >= 0 && sy < SCR_HEIGHT) {
                vram[sy * BUF_WIDTH + sx] = color;
            }
        }
    }
}

void rendererDrawSprite(int x, int y, int width, int height, unsigned int* pixels) {
    unsigned int* vram = (unsigned int*)sceGuSwapBuffers();
    if (!vram) vram = (unsigned int*)fbp0;
    
    for (int py = 0; py < height; py++) {
        for (int px = 0; px < width; px++) {
            int sx = x + px;
            int sy = y + py;
            if (sx >= 0 && sx < SCR_WIDTH && sy >= 0 && sy < SCR_HEIGHT) {
                unsigned int pixel = pixels[py * width + px];
                if ((pixel & 0xFF000000) != 0) { // Alpha test
                    vram[sy * BUF_WIDTH + sx] = pixel;
                }
            }
        }
    }
}
